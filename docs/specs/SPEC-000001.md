# SPEC-000001 通知类 skill（devflow-notifier）

## 1. 概述

为 devflow-core 新增通知类 skill，用于在“本轮任务全部完成”时，通过 Telegram Bot 发送通知。仅支持发送消息，不提供 webhook 接收。
在会话开始时检查绑定状态（.env），未绑定立即提示用户完成绑定。

## 2. 需求映射

| PRD 需求 | 设计模块/接口 | 说明 |
|----------|---------------|------|
| 绑定配置/提示 | scripts/setup_tg_env.sh / scripts/notify_tg.sh | 初始化 .env 并在缺失时提示绑定 |
| 消息推送 | scripts/notify_tg.sh | 调用 TG Bot API 发送消息 |
| 模板拼装 | 脚本参数 | 标题+正文拼装 |
| 退出码 | 脚本返回码 | 成功 0 / 失败非 0 |
| Dry-run | --dry-run | 仅输出不发送 |

## 3. 约束与假设

- 运行环境具备 bash + curl（或 python3，如 bash 不满足则切换）
- 通过环境变量注入密钥：`TG_BOT_TOKEN`、`TG_CHAT_ID`
- .env 位于 `skills/devflow-notifier/`，仅本地存放
- 网络可访问 Telegram API

## 4. 技术选型

| 类别 | 选择 | 理由 |
|------|------|------|
| 脚本语言 | bash + curl | 轻量、依赖少、易部署 |

## 5. 架构设计

```
skills/devflow-notifier/
  SKILL.md
  scripts/
    setup_tg_env.sh
    notify_tg.sh
```

## 6. 接口设计

### 6.1 notify_tg.sh

- 命令：
  - `scripts/notify_tg.sh --title "..." --message "..." [--project "..."] [--event "..."] [--dry-run]`
- 环境变量：
  - `TG_BOT_TOKEN`
  - `TG_CHAT_ID`
- 行为：
  - 缺少必要变量时返回非 0 并打印错误
  - 若 `.env` 缺失，提示绑定步骤并退出
  - `--dry-run` 时仅输出拼装内容，不发送

### 6.2 setup_tg_env.sh

- 命令：
  - `scripts/setup_tg_env.sh`
- 行为：
  - 交互式录入 `TG_BOT_TOKEN`、`TG_CHAT_ID`
  - 生成 `skills/devflow-notifier/.env` 并设置安全权限

## 7. 数据模型

无持久化数据模型。

## 8. 关键逻辑与流程

1) 会话开始时检查 `.env` 是否存在，缺失则提示绑定
2) 读取环境变量与参数
3) 组装消息文本（标题 + 正文 + 可选项目/事件）
4) dry-run 时直接输出
5) 正常路径调用 TG Bot API sendMessage
6) 检查响应 ok=true，返回 0

## 9. 非功能目标

- 单次调用 < 3s（网络正常）
- 错误信息简洁可读

## 10. 安全与风险

- 不在仓库中存储 Token/ChatID
- 输出内容避免包含敏感信息

## 11. 兼容与版本策略

- 向后兼容：新增 skill，不影响既有流程

## 12. 回滚与迁移

- 删除 `skills/devflow-notifier/` 目录即可回滚

## 13. 影响范围

- 新增文件：`skills/devflow-notifier/SKILL.md`、`skills/devflow-notifier/scripts/setup_tg_env.sh`、`skills/devflow-notifier/scripts/notify_tg.sh`
- 修改文件：`README.md`（新增 skill 列表）

## 14. 触发时机定义

- 通知仅在“本轮任务全部完成”时触发
- 批量任务完成条件：待开发清单为空且逻辑问题清单为空
- 会话开始时如果未绑定，优先提示绑定并停止后续动作
