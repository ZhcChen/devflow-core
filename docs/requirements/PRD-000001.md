# PRD-000001 通知类 skill（devflow-notifier）

## 1. 需求背景

当前工作流程已形成多角色 skill 与文档化产出，但缺少“任务完成/阶段完成”的通知能力。
希望在任务完成或关键阶段完成时，通过 TG Bot 发送通知，便于跨项目追踪进度。
同时需要提供本地绑定配置（.env），并在对话开始时提示用户完成绑定。

## 2. 目标与范围

目标：新增通知类 skill，使 Orchestrator 或角色流程在指定时机可触发通知。
范围：包含“绑定配置与提醒 + 发送消息”能力，不做 webhook 接收与交互。

## 3. 用户画像与场景

- 主 Agent：在任务完成后发送通知
- 项目维护者：需要被动接收进度提醒

## 4. 关键流程

1) 会话开始检查绑定状态（.env），缺失则提示用户完成绑定并停止后续动作
2) Orchestrator 判断触发条件
3) 调用通知脚本并传入消息内容
4) TG Bot 推送消息

## 5. 业务规则与约束

- 仅使用环境变量注入密钥，不允许写入仓库
- .env 存放于 skill 目录并必须被 git 忽略
- 会话开始即提示绑定，未绑定不得进入发送流程
- 失败需明确返回非 0 退出码

## 6. 功能列表

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 绑定配置 | 本地 .env 记录 token/chat_id | P0 |
| 绑定提示 | 会话开始提示用户绑定 | P0 |
| 消息推送 | 发送 TG 消息 | P0 |
| 模板拼装 | 支持标题+正文 | P0 |
| 退出码 | 成功 0 / 失败非 0 | P0 |
| 日志输出 | 输出简洁错误信息 | P1 |
| Dry-run | 仅打印消息不发送 | P1 |

## 7. 功能详情

### 7.1 TG 消息推送
- 描述：调用 Telegram Bot API 的 sendMessage
- 用户故事：作为主 Agent，我希望在任务完成时通知到 TG，以便及时获知进度。
- 验收标准：
  - [ ] 提供 token/chat_id 后可成功推送消息
  - [ ] 参数缺失时返回明确错误
- 成功/失败边界：
  - 成功条件：API 返回 ok=true
  - 失败条件：网络错误或 API 返回错误

### 7.2 绑定配置与提示
- 描述：通过本地 .env 保存 TG Bot Token/Chat ID，并在会话开始时提示绑定
- 用户故事：作为主 Agent，我希望在会话开始就检查是否已绑定，避免临时失败。
- 验收标准：
  - [ ] 未配置 .env 时提示绑定步骤并退出
  - [ ] 配置 .env 后可正常发送

## 8. 非功能需求

- 性能：单次调用 < 3s（网络正常）
- 安全：密钥仅通过环境变量
- 兼容性：bash + curl / python3（任选其一，最终以实现为准）

## 9. 版本规划

- MVP：TG 消息推送 + 退出码
- V1：增加模板拼装 + Dry-run
- V2：多渠道扩展（Slack/企业微信）

## 10. 不做什么

- 不实现 TG webhook
- 不处理消息回执状态存储

## 11. 已确认事项

- 触发时机：仅在“本轮任务全部完成”时通知
- 通知内容：标题 + 正文 + 可选项目/事件

## 12. 验收矩阵

验收标准与填写规则见 [requirements/](./index.md)。
用例ID 规则见 [conventions/](../conventions/)。

| 功能点 | 前置条件 | 验收标准 | 验收方式 | 用例ID | 负责人 | 状态 |
|--------|----------|----------|----------|--------|--------|------|
| 绑定提示 | 未配置 .env | 提示绑定步骤并退出非 0 | 手动 |  | Tester | 未开始 |
| 消息推送 | 设置 TG_BOT_TOKEN/TG_CHAT_ID | 调用脚本成功推送消息 | 手动 |  | Tester | 未开始 |
| 参数校验 | 未设置必要环境变量 | 返回错误并退出非 0 | 手动 |  | Tester | 未开始 |
| Dry-run | 传入 dry-run 参数 | 不发送消息但输出内容 | 手动 |  | Tester | 未开始 |

## 13. 指标与验收口径

- 成功率：发送成功 / 调用次数
- 失败率：发送失败 / 调用次数

## 14. 风险与依赖

- 依赖 TG Bot Token/Chat ID
- 网络不可用时会失败
- 本地 .env 管理不当可能导致配置丢失

## 15. 变更记录

## 16. 术语表

- TG：Telegram
- Bot Token：Telegram 机器人访问令牌
